# Heap and Stack

## C#中的值类型和引用类型

C#中类型被分为两种：值类型（基本数据类型、枚举类型、结构类型）和引用类型（类、接口、数组）。

1. 值类型只需要一段单独的存储，用于存储实际的数据（单独定义的时候放在栈中）。
2. 引用类型需要两段内存。
    1. 第一段存储实际的数据，它总是位于堆中。
    2. 第二段是一个引用，指向数据在堆中的存放地址。

补充：全局变量通常被分配在静态数据区（Static Data Area）或全局数据区（Global Data Area），而不是栈区和堆区。这些区域属于程序的静态存储区域，用于存储全局变量和静态变量等数据。
- 静态数据区：
    - 静态数据区是存储静态变量和类变量的内存区域，在程序启动时就会分配。
    - 这里存储的数据在整个程序的生命周期内都存在，直到程序结束。
- 全局数据区：
    - 全局数据区用于存储全局变量，其内存分配和释放也是在程序启动和结束时进行的。
    - 全局变量在程序中所有函数之外声明，因此可以在任何函数中访问和修改这些变量。

![!\[alt text\](/image/堆栈存储.png)](../../../image/堆栈存储.png)

### 1. 值类型与引用类型的存储方式

- 值类型：值类型总是分配在它声明的地方，作为局部变量时，存储在栈上；类对象的字段时，则跟随此类存储在堆中。
- 引用类型：引用类型存储在堆中。类型实例化的时候，会在堆中开辟一部分空间存储类的实例。类对象的引用还是在栈中。

### 2. 案例

```c#
int num = 100; // 值类型 保存在栈中
int[] nums = {1,2,3,4,5}; // 引用类型保存在堆中
Console.WriteLine(num);
Console.WriteLine(nums);
//out
//100
//System.Int32[]
```

通过上面这个例子，我们可以看到，num为值类型，所以它直接输出了值，而我们的nums为引用类型，它无法直接输出值，而是输出了一个引用。

### 3. 值类型与引用类型的区别

1. 值类型与引用类型都继承自`System.Object`类，不同之处，几乎所有的引用类型都是直接从`System.Object`继承，而值类型则是继承`System.Object`的子类`System.ValueType`类。
2. 我们在给引用类型的变量赋值的时候，其实只是赋值了对象的引用；而给值类型变量赋值的时候，是创建了一个副本（就是克隆了一个变量）。

## 堆与栈简单理解

C# 程序在CLR上运行的时候，内存从逻辑上划分两大块：栈、堆，这俩基本元素组成我们C#程序的运行环境。

### 1. 堆与栈概念

堆：在c里面叫堆，在C#里面其实叫托管堆。

栈：就是堆栈。

### 2. 托管堆

托管堆不同于堆，它是由CLR（Common Language Runtime）管理，当堆中满了之后，会自动清理堆中的垃圾。所以，做为.net开发，不需要关心内存释放的问题。

### 3.内存堆栈和数据堆栈

1. 内存堆栈：存在内存中的两个存储区（堆区，栈区）。
    1. 栈区：存放函数的参数、局部变量、返回数据等值，由编译器自动释放。
    2. 堆区：存放着引用类型的对象，由CLR释放。
2. 数据堆栈：是一种后进先出的数据结构，它是一个概念，主要是栈区。

## 堆区与栈区别分析

栈通常保存着我们代码执行的步骤，如一个值类型的变量的初始化或者一个方法的声明，而堆上存放的则多是对象，数据等。我们可以把栈想象成一个接着一个叠放在一起的盒子。当我们使用的时候，每次从最顶部取走一个盒子。同样，我们的栈也是如此，当一个方法（或类型）被调用完成的时候，就从栈顶取走，接着下一个，这也就是常说的“后进先出”。堆则不然，像是一个仓库，储存着我们使用的各种对象等信息，当我们需要调用的时候，会去里面自行寻找并调用。跟栈不同的是它们被调用完毕不会立即被清理掉。

> 在C#中，内存管理是由.NET运行时（CLR）自动进行的，其中包括堆内存和栈内存的管理。栈内存用于存储局部变量、方法参数和方法调用的上下文信息，当一个方法被调用时，会在栈上分配一段空间给该方法使用，这段空间称为栈帧（Stack frame）。当方法执行完毕后，栈帧会被弹出，栈上的空间也会被释放。因此，栈上的内存空间是遵循LIFO原则的，即最后进入栈中的栈帧会先被调用并释放，所以栈上的空间会在方法调用结束时自动被清理，这意味着栈上分配的局部变量、方法参数等在方法执行完成后会被自动清理，开发者无需手动管理栈上的内存空间。而堆上的内存空间则由垃圾回收器（Garbage Collector）负责管理和释放。

## 堆与栈存储

我们把内存分为堆空间和栈空间，区别如下：

1. 栈空间比较小，但是读取速度快。
2. 堆空间比较大，但是读取速度慢。

### 1. 栈

栈（Stack）最明显的特征就是FILO，本质上堆栈也是一种线性结构，符合线性结构的基本特点：即每个节点有且只有一个前驱节点和一个后续节点。栈把所有操作限制在“只能在线性结构的某一端”进行，而不能在中间插入或删除元素。我们把数据放入栈顶称为入栈，从栈顶删除数据称为出栈。

### 2. 堆

堆（Heap）是一块内存区域，与栈不同，堆里的内存能够以任意顺序存入和移除。

## GC（Garbage Collection）垃圾收集器

CLR的GC就是内存管理机制，我们写程序不需要关心内存的使用，因为这些都是CLR帮我们做了。


